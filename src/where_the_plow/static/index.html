<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Where the Plow</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@5/dist/maplibre-gl.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #info-panel {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(20, 20, 30, 0.85);
      color: #e5e7eb;
      padding: 14px 18px;
      border-radius: 8px;
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 13px;
      line-height: 1.5;
      z-index: 10;
      min-width: 180px;
      backdrop-filter: blur(6px);
    }
    #info-panel h3 {
      margin: 0 0 6px 0;
      font-size: 15px;
      color: #f9fafb;
    }
    #info-panel a {
      color: #93c5fd;
      text-decoration: none;
    }
    #info-panel a:hover {
      text-decoration: underline;
    }
    #vehicle-count {
      color: #9ca3af;
      font-size: 12px;
      margin-top: 6px;
    }
    #vehicle-detail {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.12);
      display: none;
    }
    #vehicle-detail .detail-name {
      font-weight: 600;
      color: #f9fafb;
      margin-bottom: 2px;
    }
    #vehicle-detail .detail-row {
      color: #9ca3af;
      font-size: 12px;
    }
    #vehicle-detail .detail-close {
      float: right;
      cursor: pointer;
      color: #6b7280;
      font-size: 16px;
      line-height: 1;
      margin: -2px -4px 0 8px;
    }
    #vehicle-detail .detail-close:hover {
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info-panel">
    <h3>Where the Plow</h3>
    <a href="/docs">API Documentation</a>
    <div id="vehicle-count">Loading vehicles...</div>
    <div id="vehicle-detail">
      <span class="detail-close" id="detail-close">&times;</span>
      <div class="detail-name" id="detail-name"></div>
      <div class="detail-row" id="detail-type"></div>
      <div class="detail-row" id="detail-speed"></div>
      <div class="detail-row" id="detail-bearing"></div>
      <div class="detail-row" id="detail-updated"></div>
    </div>
  </div>
  <script>
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://tiles.openfreemap.org/styles/liberty',
      center: [-52.71, 47.56],
      zoom: 12,
    });

    function formatTimestamp(ts) {
      const d = new Date(ts);
      return d.toLocaleString(undefined, {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
      });
    }

    function updateVehicleCount(data) {
      const count = data.features ? data.features.length : 0;
      document.getElementById('vehicle-count').textContent =
        count + ' vehicle' + (count !== 1 ? 's' : '') + ' tracked';
    }

    async function fetchVehicles() {
      const resp = await fetch('/vehicles');
      return resp.json();
    }

    // Track the currently selected vehicle
    let activeVehicleId = null;
    let activeVehicleTimestamp = null;

    const detailPanel = document.getElementById('vehicle-detail');
    const detailName = document.getElementById('detail-name');
    const detailType = document.getElementById('detail-type');
    const detailSpeed = document.getElementById('detail-speed');
    const detailBearing = document.getElementById('detail-bearing');
    const detailUpdated = document.getElementById('detail-updated');

    document.getElementById('detail-close').addEventListener('click', () => {
      closeDetail();
    });

    function showDetail(p) {
      detailName.textContent = p.description;
      detailType.textContent = p.vehicle_type;
      detailSpeed.textContent = 'Speed: ' + p.speed + ' km/h';
      detailBearing.textContent = 'Bearing: ' + p.bearing + '\u00B0';
      detailUpdated.textContent = 'Updated: ' + formatTimestamp(p.timestamp);
      detailPanel.style.display = 'block';
    }

    function closeDetail() {
      detailPanel.style.display = 'none';
      activeVehicleId = null;
      activeVehicleTimestamp = null;
      clearTrail();
    }

    const ONE_DAY_MS = 24 * 60 * 60 * 1000;

    // Filter out vehicles with timestamps older than 24 hours
    function filterRecentFeatures(data) {
      const cutoff = Date.now() - ONE_DAY_MS;
      return {
        ...data,
        features: data.features.filter(f => new Date(f.properties.timestamp).getTime() > cutoff),
      };
    }



    // Fetch last 10 minutes of history for a vehicle, anchored to its latest timestamp
    async function fetchTrail(vehicleId, vehicleTimestamp) {
      let until, since;
      if (vehicleTimestamp) {
        until = new Date(vehicleTimestamp);
        since = new Date(until.getTime() - 10 * 60 * 1000);
      } else {
        until = new Date();
        since = new Date(until.getTime() - 10 * 60 * 1000);
      }
      const resp = await fetch(
        `/vehicles/${vehicleId}/history?since=${since.toISOString()}&until=${until.toISOString()}&limit=2000`
      );
      return resp.json();
    }

    // Render a trail of fading circles for the selected vehicle
    async function showTrail(vehicleId, vehicleTimestamp) {
      clearTrail();
      const data = await fetchTrail(vehicleId, vehicleTimestamp);
      if (!data.features || data.features.length === 0) return;

      const count = data.features.length;
      // Assign an opacity to each point: oldest = most transparent, newest = most opaque
      // Minimum opacity 0.15, max 0.7 (the current live dot stays full via the main layer)
      const features = data.features.map((f, i) => ({
        ...f,
        properties: {
          ...f.properties,
          trail_opacity: count === 1 ? 0.7 : 0.15 + (i / (count - 1)) * 0.55,
        },
      }));

      const trailData = { type: 'FeatureCollection', features };

      // Build individual line segments so each can have its own opacity
      const segmentFeatures = [];
      for (let i = 0; i < features.length - 1; i++) {
        const opacity = features[i].properties.trail_opacity;
        segmentFeatures.push({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: [
              features[i].geometry.coordinates,
              features[i + 1].geometry.coordinates,
            ],
          },
          properties: { seg_opacity: opacity },
        });
      }
      const lineData = { type: 'FeatureCollection', features: segmentFeatures };

      map.addSource('vehicle-trail', { type: 'geojson', data: trailData });
      map.addSource('vehicle-trail-line', { type: 'geojson', data: lineData });

      // Trail line segments with fading opacity
      map.addLayer({
        id: 'vehicle-trail-line',
        type: 'line',
        source: 'vehicle-trail-line',
        paint: {
          'line-color': '#60a5fa',
          'line-width': 3,
          'line-opacity': ['get', 'seg_opacity'],
        },
      }, 'vehicle-circles'); // insert below the main circles

      // Trail dots with fading opacity
      map.addLayer({
        id: 'vehicle-trail-dots',
        type: 'circle',
        source: 'vehicle-trail',
        paint: {
          'circle-color': '#60a5fa',
          'circle-radius': 4,
          'circle-opacity': ['get', 'trail_opacity'],
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 1,
          'circle-stroke-opacity': ['*', ['get', 'trail_opacity'], 0.8],
        },
      }, 'vehicle-circles'); // insert below the main circles
    }

    function clearTrail() {
      if (map.getLayer('vehicle-trail-dots')) map.removeLayer('vehicle-trail-dots');
      if (map.getLayer('vehicle-trail-line')) map.removeLayer('vehicle-trail-line');
      if (map.getSource('vehicle-trail')) map.removeSource('vehicle-trail');
      if (map.getSource('vehicle-trail-line')) map.removeSource('vehicle-trail-line');
    }

    async function refreshTrail() {
      if (!activeVehicleId) return;
      const data = await fetchTrail(activeVehicleId, activeVehicleTimestamp);
      if (!data.features || data.features.length === 0) return;

      const count = data.features.length;
      const features = data.features.map((f, i) => ({
        ...f,
        properties: {
          ...f.properties,
          trail_opacity: count === 1 ? 0.7 : 0.15 + (i / (count - 1)) * 0.55,
        },
      }));

      const trailSource = map.getSource('vehicle-trail');
      if (trailSource) {
        trailSource.setData({ type: 'FeatureCollection', features });
      }

      const segmentFeatures = [];
      for (let i = 0; i < features.length - 1; i++) {
        segmentFeatures.push({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: [
              features[i].geometry.coordinates,
              features[i + 1].geometry.coordinates,
            ],
          },
          properties: { seg_opacity: features[i].properties.trail_opacity },
        });
      }
      const lineSource = map.getSource('vehicle-trail-line');
      if (lineSource) {
        lineSource.setData({ type: 'FeatureCollection', features: segmentFeatures });
      }
    }

    function updateDetailFromData(data) {
      if (!activeVehicleId) return;
      const feature = data.features.find(
        f => f.properties.vehicle_id === activeVehicleId
      );
      if (!feature) {
        closeDetail();
        return;
      }
      activeVehicleTimestamp = feature.properties.timestamp;
      showDetail(feature.properties);
    }

    map.on('load', async () => {
      const rawData = await fetchVehicles();
      const data = filterRecentFeatures(rawData);
      updateVehicleCount(data);

      map.addSource('vehicles', {
        type: 'geojson',
        data: data,
      });

      map.addLayer({
        id: 'vehicle-circles',
        type: 'circle',
        source: 'vehicles',
        paint: {
          'circle-color': [
            'match',
            ['get', 'vehicle_type'],
            'SA PLOW TRUCK', '#2563eb',
            'TA PLOW TRUCK', '#2563eb',
            'LOADER', '#ea580c',
            'GRADER', '#16a34a',
            '#6b7280',
          ],
          'circle-radius': 7,
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 2,
        },
      });

      // Pointer cursor on hover
      map.on('mouseenter', 'vehicle-circles', () => {
        map.getCanvas().style.cursor = 'pointer';
      });
      map.on('mouseleave', 'vehicle-circles', () => {
        map.getCanvas().style.cursor = '';
      });

      // Click: show detail panel + trail
      map.on('click', 'vehicle-circles', async (e) => {
        const feature = e.features[0];
        const p = feature.properties;

        activeVehicleId = p.vehicle_id;
        activeVehicleTimestamp = p.timestamp;
        showDetail(p);
        await showTrail(p.vehicle_id, p.timestamp);
      });

      // Auto-refresh
      setInterval(async () => {
        try {
          const rawData = await fetchVehicles();
          const freshData = filterRecentFeatures(rawData);
          map.getSource('vehicles').setData(freshData);
          updateVehicleCount(freshData);
          updateDetailFromData(freshData);
          refreshTrail();
        } catch (err) {
          console.error('Failed to refresh vehicles:', err);
        }
      }, 6000);
    });
  </script>
</body>
</html>
